<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="记录个人的技术及思考心得">
<meta name="keywords" content="linux code">
<meta property="og:type" content="website">
<meta property="og:title" content="wangfan 的小屋">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="wangfan 的小屋">
<meta property="og:description" content="记录个人的技术及思考心得">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="wangfan 的小屋">
<meta name="twitter:description" content="记录个人的技术及思考心得">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>wangfan 的小屋</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?32f9c7c73e7858194dc26b950e49983a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wangfan 的小屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/05/tcl-language/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/05/tcl-language/" itemprop="url">tcl/tk语言</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-05T21:54:10+08:00">
                2018-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="研究了一下tcl-tk语言"><a href="#研究了一下tcl-tk语言" class="headerlink" title="研究了一下tcl/tk语言"></a>研究了一下tcl/tk语言</h2><p>作为一名在网络公司的研发工程师，每次测试都要敲一大堆命令，之前测试的同事一直用tcl脚本来实现自动化，自己因为测试较少没有深入地了解这门语言。有一次因要测试大量的重复命令。用了tcl写完脚本后，节省了自己80%的测试时间，感觉心里痛快不少。对tcl有了进一步了解的兴趣。</p>
<h2 id="tcl发明人"><a href="#tcl发明人" class="headerlink" title="tcl发明人"></a>tcl发明人</h2><p>Tcl是伯克利作品，在SUN生存过一段时间，现在则是很小规模的社区委员会在维护，主要的优化是性能和兼容性，缓慢和保守的加入新特性。</p>
<p>Tcl出现的年代，GUI刚起步；在各种当时还是非常封闭的平台上写高效的GUI程序并不容易，Tk图形库一出现就受到了极大欢迎，它让程序员可以非常快速的创建简单GUI应用；时至今日，包括Python在内的很多语言，最早和缺省支持的GUI Toolkit仍然是Tk，虽然界面看起来实在土不堪言；SUN选择了Java放弃了Tcl是对Tcl的最大打击；之后Tcl的创始人Ousterhout将Tcl和他创办的公司一起卖给了其他公司并离开了核心开发团队，这门语言开始停滞发展并迅速被其他活跃的商业语言或社区语言超越；到现在你已经基本上听不到它的名字了；目前Tcl还在使用的一些地方包括EDA软件的内嵌语言，某些型号的Cisco的路由器脚本，自动化测试框架，等等；</p>
<h2 id="tcl-的评价"><a href="#tcl-的评价" class="headerlink" title="tcl 的评价"></a>tcl 的评价</h2><p>Richard Stallman明确表示Tcl是Toy language，因为，没数据结构可用，于是完全无法展示CS背景人士的专业性所在；但反过来说，构筑在数学上的CS，并非每个人都能理解，反之，我们的自然语言也不像数学那样抽象，它是不严谨，但是这不妨碍使用者经过训练之后将他用于诸如法律文书、药物说明或者科学论文等非常严谨精确的地方，看你怎么使用。这就是Tcl，易学，也不难精，简洁，一种抽象规则，变化无穷。</p>
<h2 id="tcl-的应用范围"><a href="#tcl-的应用范围" class="headerlink" title="tcl 的应用范围"></a>tcl 的应用范围</h2><p>Tcl是跨平台的，但是很明显在习惯上它是unix哲学体系的。一个是前面说的类shell和类c语法，另外，在unix上，命令加参数几乎是一切非ui程序的工作方式，如果你用C写程序，最简单的也是这类，而Tcl的基本执行单元就是命令加参数，这不但意味着你可以直接调用外部程序，你还可以在脚本函数出现性能瓶颈的时候直接打开文本编辑器写一段C代码然后编译一下，就在Tcl里把脚本函数改成外部调用就可以了，既不用写库，也不用写界面定义文件。unix上另一类命令行程序是程序自身也类似shell，比如gdb，ssh，ftp，telnet等等，它们不能简化成一个命令加一组参数工作。没问题，Tcl有个非常流行的库叫expect，就是对付这种情况的利器，把Tcl脚本伪装成一个交互shell用户，填输入进去，取输出结果回来。所以你看到了，Tcl是命令和Interactive Shell自动化的超级利器，这也就难怪它在自动测试领域那么流行了。象Sqlite测试，给它测试数据库文件，命令行SQL操作，对比结果；象GCC/GDB，提交测试文件，自动执行，对比输出或者返回信息；象一个modem模块，可以AT Command发过去，检查返回信息，solicited，unsolicited；等等，诸如此类。Tk是Tcl另一个引以为豪的地方。一句脚本就能创建对话框。我不清楚它对复杂窗口程序的控制力如何，实际用Tcl/Tk交付的UI商业程序是有的，但不多，</p>
<h2 id="tcl的设计理念"><a href="#tcl的设计理念" class="headerlink" title="tcl的设计理念"></a>tcl的设计理念</h2><p>Tcl则处在一个奇怪的位置；它现在在TIOBE的排名是100左右，基本上排在大多数程序员听说过的所有编程语言之后，但它曾经很流行，在Java出现之前；在它流行的年代，计算设备的性能很低；Unix Shell是主要的竞争对手，LISP是一个美丽的泡泡；所以Tcl从一出生开始在形式上就带有这两种语言的特点：Shell的字符串展开，LISP的表达式优先和空格分隔符；这两点可能让熟悉类C语法的大多数现代程序员都不适应；</p>
<p>应用程序使用Tcl作为它的命令语言有三个好处：</p>
<p>1 Tcl提供了标准语法，一旦用户掌握了Tcl就可以很容易的发布命令给基于Tcl的程序。</p>
<p>2 Tcl实现了很多的功能，使你的工作变得很方便。</p>
<p>3 TCl可作为程序间通信的接口。</p>
<p>Tcl 代表 “tool command language” 发音为 “tickle.” 。它实际上包含了两个部分：一个语言和一个库。</p>
<p>首先，Tcl是一种简单的脚本语言，主要使用于发布命令给一些互交程序如文本编辑器、调试器和shell。它有一个简单的语法和很强可扩充性，Tcl可以创建新的过程以增强其内建命令的能力。</p>
<p>其次，Tcl是一个库包，可以被嵌入应用程序，Tcl的库包含了一个分析器、用于执行内建命令的例程和可以使你扩充（定义新的过程）的库函数。应用程序可以产生Tcl命令并执行，命令可以由用户产生，也可以从用户接口的一个输入中读取（按钮或菜单等）。但Tcl库收到命令后将它分解并执行内建的命令，经常会产生递归的调用。</p>
<p>Tcl Interpreters 解释器在Tcl的数据结构中的核心是Tcl_Interp.一个解释器包含了一套命令，一组变量和一些用于描述状态的东西。每一个 Tcl命令是在特定的Tcl_Interp中运行的,基于Tcl的应用程序可以同时拥有几个Tcl_Interp。Tcl_Interp是一个轻量级的结构，可以快速的新建和删除。</p>
<p>Tcl Data Types 数据类型Tcl只支持一种数据结构：字符串（string）。所有的命令，命令的所有的参数，命令的结果，所有的变量都是字符串。请牢记这一点，所有的东西都是字符串。然而字符串的实际解释是依赖于上下文或命令的。它有三种形式：命令(command), 表达式(expresion)和表(list)。下面会讨论细节。</p>
<p>Basic Command Syntax 基本语法Tcl有类似于shell和lisp的语法，当然也有许多的不同。一条Tcl的命令串包含了一条或多条命令用换行符或分号来隔开，而每一条命令包含了一个域(field)的集合，域使用空白分开的，第一个域是一个命令的名字，其它的是作为参数来传给它。例如：set a 22 //相当于C中的 a=22 a是一个变量这条命令分为三个域：<code>1： set 2： a 3： 22</code>   set使用于设置变量的值的命令，a、20 作为参数来传给它，a使它要操作的变量名，22是要付给的a值。Tcl的命令名可以使内建的命令也可以是用户建的新命令，在应用程序中用函数Tcl_CreateCommand 来创建。所有的参数作为字符串来传递，命令自己会按其所需来解释的参数的。命令的名字必须被打全，但 Tcl解释器找不到一同名的命令时会用 unknown命令来代替。</p>
<h2 id="tcl-的语法简介"><a href="#tcl-的语法简介" class="headerlink" title="tcl 的语法简介"></a>tcl 的语法简介</h2><p>Command summary 命令综述</p>
<blockquote>
<p>1.一个命令就是一个字符串（string）。</p>
<p>2.命令是用换行符或分号来分隔的。</p>
<p>3.一个命令由许多的域组成。第一个于是命令名，其它的域作为参数来传递。</p>
<p>4.域通常是有空白（Tab横向制表健 Space空格）来分开的。</p>
<p>5.双引号可以使一个参数包括换行符或分号。三种子替换仍然发生。</p>
<p>6.花括号类似于双引号，只是不进行三总体换。</p>
<p>7.系统只进行一层子替换，机制替换的结果不会再去做子替换。而且子替换可以在任何一个域进行。</p>
<p>8.如果第一个非控字符是`#’, 这一行的所有东西都是注释。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/04/kernel-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/kernel-test/" itemprop="url">linux 内核态函数的调试方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-04T21:06:17+08:00">
                2018-05-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##　 linux调试</p>
<p>通常我们在用户态下进行程序的编写，用一个main函数，gcc进行编译后直接在bash下执行编译生成的二进制文件即可看到程序运行结果。但内核态函数不是从main函数开始的，也无法直接在用户态运行，这时候我们一般采用module的方式来进行内核态函数的调试。</p>
<h2 id="module-的使用方法"><a href="#module-的使用方法" class="headerlink" title="module 的使用方法"></a>module 的使用方法</h2><p>以调试内核态函数printk为例。为调试pirntk函数的功能</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/03/character-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/03/character-api/" itemprop="url">字符处理函数的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-03T21:11:13+08:00">
                2018-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="字符转换函数的使用场景"><a href="#字符转换函数的使用场景" class="headerlink" title="字符转换函数的使用场景"></a>字符转换函数的使用场景</h2><p>我们在程序界面输入数据时，基本上都是用字符来保存的，所有操作系统之间的信息保存和传递也是基于字符（char）单位来进行，单位再大了就有字节序问题，不能兼容所有的操作系统了。为效率考虑，现在的信息全以字符为单位。计算一段数据的大小，比如一个变量Int的大小，用sizeof操作符返回的结果就是字节数，也就是char的个数。sizeof(int)  == 4 ，在程序应用中，比如在计数器中我们输入一串数字和符号  123 + 456 ，内部如何计算出结果呢，123在输入时是对应3个字符char，在计算的时时候我们则必须将其转换成整型变量数据再进行加法运算。C函数提供的一个函数库API是atoi, ascii to integer 的一个函数 stdlib.h，其原型是int atoi(const char * ptr)，函数开始扫描ptr字符串，跳过空白字符(isspace检测)，从数字或正负号开始，到\0或非数字结束，返回一个整数，当无法转换成整理或ptr是空字符串时返回0</p>
<p>同样的，也会有itoa函数，将整数转换成字符串，但奇怪的是这个函数却不是标准的C函数，在Linux下基本没有这个函数，通常windows下的非标准编译器才支持这种函数，我考虑了多方面因素，可能是以下原因，转换出的字符串一般都是一串不确定长度的空间，而这个内存空间只能通过指针的方式返回使用者，这样使用者调用后还需要手动释放这个空间，很容易造成内存泄露。linux下将数字转换成字符有以下几种方式</p>
<blockquote>
<h2 id="int-sprintf-char-buffer-char-fmt-…"><a href="#int-sprintf-char-buffer-char-fmt-…" class="headerlink" title="int sprintf( char * buffer,  char * fmt , …);"></a>int sprintf( char * buffer,  char * fmt , …);</h2></blockquote>
<p>sprintf最常见的应用之一莫过于把整数打印到字符串中，所以，spritnf 在大多数场合可以替代itoa。如：</p>
<ol>
<li><p>将整数转成字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span> (s, <span class="string">"%d"</span>, <span class="number">123</span>); <span class="comment">// 产生"123"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *who = <span class="string">"I"</span>;</span><br><span class="line"><span class="keyword">char</span> *whom = <span class="string">"52PHP"</span>; </span><br><span class="line"><span class="built_in">sprintf</span>(s, <span class="string">"%s love %s."</span>, who, whom); <span class="comment">// 产生："I love 52PHP. "</span></span><br></pre></td></tr></table></figure>
<p><em>spintf 常见问题</em></p>
<p>1、返回值返回的是实际写入buffer的字符长度，可以不用再用strlen计算字符长度了</p>
<p>2、如果 s 的区域不足，写入的数据超过s长度，可能会导致内存访问错误引起崩溃，</p>
</li>
</ol>
<blockquote>
<h2 id="int-snprintf-char-buf-size-t-n-char-fmt-…"><a href="#int-snprintf-char-buf-size-t-n-char-fmt-…" class="headerlink" title="int snprintf(char *buf, size_t n, char * fmt, …)"></a>int snprintf(char *buf, size_t n, char * fmt, …)</h2></blockquote>
<p>为了防止引起内存访问错误，采用snprintf函数，此函数最多从源字符串中取n-1个字符，最后一个字节补\0，写入buf，推荐用法是将第2个参数n写成sizeof(buf)，与sprintf不同的时返回值 int 是源字符串的字符数，而非实际写入buf的字符串数目。在Linux内核中不推荐用snprintf，就是因为返回的值可能大于实际写入的buf中的字符数目，可能导致计算时越界，linux内存中推荐采用返回值为实际写入buf中的字符数字函数scnprintf，用法和snprintf一样，但返回值是实际写入buf的字符数，这样就避免了返回值比实际写入buf数值还大的现象。</p>
<blockquote>
<h2 id="int-scnprintf-char-buf-size-t-n-char-fmt-…"><a href="#int-scnprintf-char-buf-size-t-n-char-fmt-…" class="headerlink" title="int scnprintf(char *buf, size_t n, char *fmt, …)"></a>int scnprintf(char *buf, size_t n, char *fmt, …)</h2></blockquote>
<p>参考文章：<a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-scnprintf.html" target="_blank" rel="noopener">https://www.kernel.org/doc/htmldocs/kernel-api/API-scnprintf.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/02/ld-preload/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/02/ld-preload/" itemprop="url">linux下不重编译替换同名函数--LD_PRELOAD</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T20:07:57+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LD-PRELOAD：利用动态链接库更改同名函数的功能"><a href="#LD-PRELOAD：利用动态链接库更改同名函数的功能" class="headerlink" title="LD_PRELOAD：利用动态链接库更改同名函数的功能"></a>LD_PRELOAD：利用动态链接库更改同名函数的功能</h2><p>linux 的程序在运行时调用的函数是以符号的形式存储在静态链接库.a文件或动态链接库.so文件中的，Linux优先查找动态链接库中的符号，如果没有再去查找静态链接库。LD_PRELOAD是linux下的一个环境变量，设置了之后，linux会优先查找LD_PRELOAD路径中的动态链接库，然后再查找默认的动态链接库，再查找静态链接库。知道了这个特性，我们就可以在不修改程序代码的情况下，通过LD_PRELOAD设置，实现程序优先调用我们自己编译的动态链接库，从而更改原有的程序代码功能。</p>
<h2 id="LD-PRELOAD-实现样例"><a href="#LD-PRELOAD-实现样例" class="headerlink" title="LD_PRELOAD 实现样例"></a>LD_PRELOAD 实现样例</h2><p>举个栗子：一个登录函数，输入密码正确后正常登录，错误返回登录失败。输入的密码与存储的密码比较函数假设原型为<em>int mycompare(const char <em> input, const char </em> origin)</em>, 当input 等于origin时返回登录成功，返回值为0，否则返回失败。如果知道了这个函数的原型，我们即可以利用LD_PRELOAD功能，自己构造一个mycompare函数，构造的这个函数比较任何数据都返回成功，这样我们就实现了破解的功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ld_preload.c 主函数 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mycompare</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a, <span class="keyword">const</span> <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * passwd = <span class="string">"pass"</span>;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"wrong arg num, must be 2! \n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == mycompare(passwd, argv[<span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"correct, it is 'pass'\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"wrong, you input : %s, the right is %s\n"</span>,argv[<span class="number">1</span>], passwd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比较函数代码如下，此函数编译成动态链接库供主函数调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* compare.c 生成.so文件 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mycompare</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a, <span class="keyword">const</span> <span class="keyword">char</span> *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>(a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译步骤如下：</p>
<blockquote>
<p>gcc compare.c -fPIC -shared -o libcompare.so</p>
<p>gcc ld_preload.c -L . -lcompare -o ld_preload</p>
</blockquote>
<p>测试结果如下：</p>
<blockquote>
<p>$ ./ld_preload pass</p>
<p>correct, it is ‘pass’</p>
<p>$ ./ld_preload a</p>
<p>wrong, you input : a, the right is pass</p>
</blockquote>
<p>现在我们新建一个myhack.c，重新实现mycompare函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* myhack.c */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mycompare</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * a, <span class="keyword">const</span> <span class="keyword">char</span> * b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// hack, any passwd is right.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译处理步骤如下，处理过后任意输入字符都会匹配输出相等，达到了替换原功能函数的目的，用unset LD_PRELOAD可以恢复原先设置：</p>
<blockquote>
<p>$ gcc myhack.c -fPIC -shared -o libmyhack.so</p>
<p>$ export LD_PRELOAD=”./libmyhack.so”</p>
<p>$ ./ld_preload a </p>
<p>correct, it is ‘pass’</p>
<p>$ unset LD_PRELOAD</p>
<p>$ ./ld_preload a</p>
<p>wrong, you input : a, the right is pass</p>
</blockquote>
<h2 id="参考知识点"><a href="#参考知识点" class="headerlink" title="参考知识点"></a>参考知识点</h2><table>
<thead>
<tr>
<th>gcc 编译选项</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>-c</td>
<td>只编译不链接，生成目标文件“.o”</td>
</tr>
<tr>
<td>-S</td>
<td>只编译不汇编，生成汇编代码</td>
</tr>
<tr>
<td>-E</td>
<td>只进行预编译，不做其他处理</td>
</tr>
<tr>
<td>-g</td>
<td>在可执行程序中包含标准调试信息</td>
</tr>
<tr>
<td>-o file</td>
<td>指定输出文件为file</td>
</tr>
<tr>
<td>-v</td>
<td>打印出编译器内部编译过程命令行信息和编译喊叫版本</td>
</tr>
<tr>
<td>-I dir</td>
<td>在头文件的搜索路径列表中添加 dir 目录</td>
</tr>
<tr>
<td>-static</td>
<td>静态编译，生成.a文件</td>
</tr>
<tr>
<td>-shared</td>
<td>1、生成动态库文件 <br>2、优先链接动态库，无动态库才链接表态库</td>
</tr>
<tr>
<td>-L dir</td>
<td>在库文件搜索路径中加入dir</td>
</tr>
<tr>
<td>-lname</td>
<td>链接名称为libname.a或libname.so的库文件，<br>如果都有时根据选项-static或-shared来选择</td>
</tr>
<tr>
<td>-fPic (或-fpic)</td>
<td>生成使用相对地址（position indepedent code），<br>生成位置无关的目标代码，通常生成动态链接库时使用</td>
</tr>
</tbody>
</table>
<h2 id="一些编译问题"><a href="#一些编译问题" class="headerlink" title="一些编译问题"></a>一些编译问题</h2><p><strong>1、如何查看一个程序中链接用到的库</strong></p>
<blockquote>
<p>用ldd 命令</p>
<p>$ ldd ld_preload<br>linux-gate.so.1 =&gt;  (0xb7f01000)<br>libcompare.so =&gt; not found<br>libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb7d31000)<br>/lib/ld-linux.so.2 (0xb7f03000)</p>
</blockquote>
<p><strong>2、gcc -L 指定路径后还是找不到.so文件</strong></p>
<blockquote>
<p>ubuntu有的是有这个问题，当时我这边是用这个命令设置了一下链接库路径就好了，故障时如上一问题所示<br>$ export LD_LIBRARY_PATH=.<br>$ ldd ld_preload<br>linux-gate.so.1 =&gt;  (0xb7f0b000)<br>libcompare.so =&gt; ./libcompare.so (0xb7f04000)<br>libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb7d38000)<br>/lib/ld-linux.so.2 (0xb7f0d000)</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/01/data-check-algrithm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/data-check-algrithm/" itemprop="url">用算法实现数据校验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T17:47:25+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="数据校验的作用"><a href="#数据校验的作用" class="headerlink" title="数据校验的作用"></a>数据校验的作用</h2><p>在数据传输的过程中，很多时候会有干扰，导致接收方的数据与发送方的数据不一致。这样就得进行数据重传或纠错等处理，例如TCP/IP协议中就有发现数据接收错误就会要求重传数据包等机制。接收方如何判断数据是否被破坏呢，这就需要数据校验算法来实现了。</p>
<h2 id="数据校验算法的需求"><a href="#数据校验算法的需求" class="headerlink" title="数据校验算法的需求"></a>数据校验算法的需求</h2><ul>
<li>尽可能少的时间复杂度和空间复杂度，让接收方能尽快完成校验以免影响正常数据传输速率</li>
<li>准确率必须达到一定值，如果校验出错肯定是有错，校验不出错可能有错。</li>
</ul>
<h2 id="数据校验位的实现"><a href="#数据校验位的实现" class="headerlink" title="数据校验位的实现"></a>数据校验位的实现</h2><p>下面介绍一种简单的数据校验算法，此算法广泛地应用在TCP/IP协议中，在TCP/IP的数据包中，一般有一个16b的数据校验位，利用这个16b的空间和一个简单的校验算法，可以很快地求出接收方数据是否有误，具体实现如下：</p>
<p>假设一个数据包的大小是20Byte,即160b(包括16b的校验位)，其数据的位数为160b-16b =144b，此算法的原理如下，在发送方构造 一个16b的校验位，使得所有160b数据在按16b相加后得到的数据为全F(或全0），接收方在收到数据后也按16b一组进行相加，如果收到的数据是全F，则说明数据正常，否则校验失败，判断数据有误，让发送方进行重发处理。</p>
<p>构造此算法考虑到以下几点：</p>
<ol>
<li><p>考虑到加法有进位，当有进位时采取进位重新加到最低位的处理方法</p>
</li>
<li><p>发送方将144b先进行16b一组的加法处理后，得到一个16b的数据，根据正码+反码=全F的特性，可以将此16b的校验大小设置成得到数据后的反码。</p>
<p>下面用C语言进行实现，（初始校验码全为0）数据假设为BUF, 大小为SIZE，计算出的校验位为16b 的 校验码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">CheckSum</span><span class="params">(<span class="keyword">void</span> * Buf, <span class="keyword">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> CheckCode = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> * p = Buf;</span><br><span class="line">  <span class="keyword">while</span>(Size &gt; <span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    sum += *p;</span><br><span class="line">      p++;</span><br><span class="line">    Size = Size - <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 如果数据大小非偶数 */</span></span><br><span class="line">  <span class="keyword">if</span> (Size == <span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    sum += *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 进位加法 */</span></span><br><span class="line">  <span class="keyword">while</span> ((sum &gt;&gt; <span class="number">16</span>) &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">     sum = (sum &amp; <span class="number">0xff</span>) + (sum &gt;&gt; <span class="number">16</span>);           </span><br><span class="line">  &#125;</span><br><span class="line">         </span><br><span class="line">  <span class="keyword">return</span> ~(<span class="keyword">unsigned</span> <span class="keyword">short</span>)sum;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/30/my-blog-setting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/30/my-blog-setting/" itemprop="url">Hexo的github配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-30T12:36:32+08:00">
                2018-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hexo的github配置"><a href="#Hexo的github配置" class="headerlink" title="Hexo的github配置"></a>Hexo的github配置</h2><p>本博客托管在github上，采用Hexo生成，使用了Next主题<br>github采用两个分支, master用于发布网站，hexo用于git源文件</p>
<p>标签和分类的页面设置方法：</p>
<blockquote>
<p>hexo new page “tags”</p>
<p>tags目录下的index.md 中属性的type: “tags”</p>
<p>hexo new page “categories”</p>
<p>categories目录下的index.md 中属性的type: “categories”</p>
</blockquote>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">Next主题</a></p>
<p><a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">Hexo主页</a></p>
<p><a href="http://dmkf.xyz/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%87%B5%E5%9C%88/" target="_blank" rel="noopener">blog参考设置</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/29/monitor-frame/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangfanstar@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wangfan 的小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/29/monitor-frame/" itemprop="url">实现一个常用的监控框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-29T12:36:32+08:00">
                2018-04-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Linux下用C语言实现监控框架"><a href="#Linux下用C语言实现监控框架" class="headerlink" title="Linux下用C语言实现监控框架"></a>Linux下用C语言实现监控框架</h2><p>假设一个工程代码分为A,B 两个模块，未来可能加上其他C,D等模块。每个模块实现不同的功能，但会调用同一个故障日志监控模块，比如A模块中有故障标志 flagA置1时会调用故障提示函数。B模块中故障标志flagB置1时调用故障提示的。正常代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">moudle A:</span><br><span class="line">	<span class="keyword">if</span>（<span class="number">1</span> == flagA)</span><br><span class="line">      	notify_user(<span class="string">"A moudle state is wrong, do step A "</span>)</span><br><span class="line">moudle B:</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> == flagB)</span><br><span class="line">      	notify_user(<span class="string">"B moudle state is wrong, do step B"</span>)</span><br></pre></td></tr></table></figure>
<p>按照这种代码架构，我们需要提供一个notify_user的接口，每次出故障时都调用一个这个接口。这种架构实现简单，容易理解，但这种接口有以下几个问题：<br>1、notify_user的接口固定死了，每个模块都需要调用这个接口，如果修改一下显示日志的格式，增加一个notify_user的参数，就要每个模块查找修改，工作量非常大，每个模块都耦合比较深。<br>2、增加一个模块时，每次都得加用这个判断语句，重复度高，不简洁。<br>根据以上缺点，我们希望构建一个模块达到以下效果：<br>1、把监控模块的notify_user的检测和输出都放到moudle monitor里面实现，其他模块需要检测时只要加一行代码，比如 register_monitor(flagA), 添加后监控模块就会自动对模块A的变量flagA进行监控，当标记置1时，输出故障信息<br>2、监控模块里面实现监控相关的内容，如果有格式修改，只在监控模块修改，不需要再找其他模块的负责人修改其他模块。实现松耦合，目的是当程序代码比较大时，修改只限制在各人负责的模块上，不会影响到其他模块的人，提高工作效率。</p>
<h2 id="监控框架的设计目标"><a href="#监控框架的设计目标" class="headerlink" title="监控框架的设计目标"></a>监控框架的设计目标</h2><p>在很多地方，我们需要对一些设备状态进行监控，比如流量达到多少时我们需要发送警告，硬件发生故障时记录日志等等，在用代码实现这些设计时，有很多设计流程是可以复用的，把这些公共的流程抽象出来，不关注 具体要监控的对象，用代码实现，后续再新增和删除监控对象时，尽可能少地对代码进行修改，而后续维护的人也可以直接参考之前的代码快速地实现监控功能的添加，删除。这就是框架的意义，如下所述：库函数是代码的复用，框架是设计的复用。</p>
<p>在实现不同业务功能的过程中，前人设计出了多种模式，简称设计模式，设计模式并没有新发明东西，是对代码编程技巧的一种总结，方便大家用于沟通描述而已。其中常用的有观察者模式，这种模式我们会在实现这个框架的过程中详细描述是哪些编程技巧是归结于这种模式，如何在不同的业务场景中使用这些模式，以及采用这种模式有什么好处。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangfanstar@163.com</p>
              <p class="site-description motion-element" itemprop="description">记录个人的技术及思考心得</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangfanstar@163.com</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
